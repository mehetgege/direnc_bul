<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3C3 Trading Bot - Signal Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* Reset ve Temel Stiller */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100% );
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: 80px; /* Sticky header için boşluk */
        }

        /* Light Theme */
        body.light-theme {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #dee2e6 100%);
            color: #212529;
        }

        /* Sticky Header - En önemli kısım */
        .sticky-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 15px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .light-theme .sticky-header {
            background: rgba(248, 249, 250, 0.95);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            color: #212529;
        }

        .sticky-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .price-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .current-price {
            font-size: 1.8rem;
            font-weight: 700;
            color: #4ECDC4;
            text-shadow: 0 2px 4px rgba(78, 205, 196, 0.3);
        }

        .light-theme .current-price {
            color: #2c3e50;
            text-shadow: none;
        }

        .price-change {
            font-size: 1rem;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .price-change.positive {
            background: rgba(0, 212, 170, 0.2);
            color: #00D4AA;
            border: 1px solid rgba(0, 212, 170, 0.3);
        }

        .price-change.negative {
            background: rgba(248, 73, 96, 0.2);
            color: #F84960;
            border: 1px solid rgba(248, 73, 96, 0.3);
        }

        .symbol-info {
            font-size: 0.9rem;
            color: #888;
            font-weight: 500;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .quick-status {
            font-size: 0.8rem;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: 600;
            text-align: center;
        }

        .status-connected {
            background: rgba(0, 212, 170, 0.2);
            color: #00D4AA;
            border: 1px solid rgba(0, 212, 170, 0.3);
        }
        
        .status-disconnected {
            background: rgba(248, 73, 96, 0.2);
            color: #F84960;
            border: 1px solid rgba(248, 73, 96, 0.3);
        }
        
        .status-trading {
             /* Bu sınıf artık kullanılmıyor ama stil olarak kalabilir */
            background: rgba(255, 193, 7, 0.2);
            color: #FFC107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        /* Container ve Grid Sistem */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .main-header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(15px);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .light-theme .main-header {
            background: rgba(255,255,255,0.8);
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        /* Panel Tasarımı */
        .panel {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(15px);
            border-radius: 18px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .light-theme .panel {
            background: rgba(255,255,255,0.9);
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
       
        .panel:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.4);
            border-color: rgba(78, 205, 196, 0.3);
        }

        .panel h3 {
            color: #4ECDC4;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid rgba(78, 205, 196, 0.2);
            padding-bottom: 10px;
        }

        .light-theme .panel h3 {
            color: #2c3e50;
            border-bottom-color: rgba(44, 62, 80, 0.2);
        }

        /* Buton Tasarımları */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.success {
            background: linear-gradient(135deg, #00D4AA, #00ff88);
            color: #000;
            box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
        }

        .btn.success:hover {
            box-shadow: 0 8px 20px rgba(0, 212, 170, 0.4);
        }

        .btn.danger {
            background: linear-gradient(135deg, #F84960, #FF6B6B);
            box-shadow: 0 4px 12px rgba(248, 73, 96, 0.3);
        }

        .btn.danger:hover {
            box-shadow: 0 8px 20px rgba(248, 73, 96, 0.4);
        }

        .btn.warning {
            background: linear-gradient(135deg, #FFC107, #FF8F00);
            color: #000;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .btn.warning:hover {
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.4);
        }

        .btn.info {
            background: linear-gradient(135deg, #4ECDC4, #45B7D1);
            color: #000;
            box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
        }

        .btn.info:hover {
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4);
        }

        /* Input ve Form Elemanları */
        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            color: #fff;
            margin: 10px 0;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4ECDC4;
            background: rgba(255,255,255,0.1);
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }

        .light-theme input, .light-theme select, .light-theme textarea {
            background: rgba(0,0,0,0.05);
            border: 2px solid rgba(0,0,0,0.1);
            color: #212529;
        }

        .light-theme input:focus, .light-theme select:focus, .light-theme textarea:focus {
            border-color: #2c3e50;
            background: rgba(0,0,0,0.08);
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
        }

        input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .light-theme input::placeholder {
            color: rgba(0,0,0,0.5);
        }

        /* Responsive Tasarım */
        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                gap: 20px;
            }
            
            .sticky-content {
                padding: 0 15px;
            }
            
            .current-price {
                font-size: 1.6rem;
            }
        }

        @media (max-width: 768px) {
            body {
                padding-top: 120px;
            }
            
            .sticky-header {
                padding: 12px 15px;
            }
            
            .sticky-content {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .current-price {
                font-size: 1.4rem;
            }
            
            .price-change {
                font-size: 0.9rem;
            }
            
            .container {
                padding: 15px;
            }
            
            .grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .main-header {
                padding: 20px 15px;
            }
            
            .panel {
                padding: 18px;
            }
            
            .header-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            body {
                padding-top: 140px;
            }
            
            .current-price {
                font-size: 1.2rem;
            }
            
            .price-change {
                font-size: 0.8rem;
                padding: 4px 8px;
            }
            
            .container {
                padding: 10px;
            }
            
            .main-header {
                padding: 15px 10px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 13px;
                margin: 4px;
            }
            
            .panel {
                padding: 15px;
                border-radius: 15px;
            }
            
            .grid {
                gap: 12px;
            }
        }
        
    </style>
</head>
<body>
    <!-- Sticky Header -->
    <div class="sticky-header">
        <div class="sticky-content">
            <!-- Sol taraf: Fiyat bilgileri -->
            <div class="price-section">
                <div class="current-price" id="stickyPrice">$0.00000000</div>
                <div class="price-change positive" id="stickyChange">
                    <span>📈</span>
                    <span>+0.000%</span>
                </div>
                <div class="symbol-info" id="stickySymbol">Coin seçin</div>
            </div>
            
            <!-- Sağ taraf: Durum kontrolleri -->
            <div class="header-controls">
                <div class="quick-status status-disconnected" id="stickyConnection">
                    🔴 Bağlantısız
                </div>
                <button class="btn info" onclick="scrollToTop()" style="padding: 8px 12px; font-size: 12px;">
                    ⬆️ Üst
                </button>
            </div>
        </div>
    </div>

    <!-- Ana Container -->
    <div class="container">
        <!-- Ana Header -->
        <div class="main-header">
            <h1 style="font-size: 2.5rem; margin-bottom: 20px; background: linear-gradient(135deg, #4ECDC4, #00D4AA); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                🚀 3C3 Advanced Signal Bot
            </h1>
            
            <div style="margin: 25px 0;">
                <div style="font-size: 3rem; font-weight: 700; color: #4ECDC4; margin-bottom: 10px; text-shadow: 0 4px 8px rgba(78, 205, 196, 0.3);" id="mainHeaderPrice">
                    $0.00000000
                </div>
                <div style="font-size: 1.3rem; display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <span id="mainHeaderChange" style="padding: 8px 16px; border-radius: 25px; font-weight: 600;">📈 +0.000%</span>
                    <span style="font-size: 1rem; color: #888; font-weight: 500;" id="mainHeaderSymbol">Sembol yok</span>
                    <span style="font-size: 0.9rem; color: #666;" id="lastUpdateTime">Son güncelleme: -</span>
                </div>
            </div>
            
            <!-- Durum İndikatörleri -->
            <div style="display: flex; justify-content: center; gap: 25px; margin-top: 30px; flex-wrap: wrap;">
                <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 15px; min-width: 140px;">
                    <div style="font-size: 0.8rem; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Bağlantı Durumu</div>
                    <div id="mainConnectionStatus" style="font-size: 1rem; font-weight: 600; color: #F84960;">🔴 Bağlantı Yok</div>
                </div>
                
                <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 15px; min-width: 140px;">
                    <div style="font-size: 0.8rem; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">AI Durumu</div>
                    <div id="mainAiStatus" style="font-size: 1rem; font-weight: 600; color: #4ECDC4;">🧠 AI Bekliyor</div>
                </div>
                
                <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 15px; min-width: 140px;">
                    <div style="font-size: 0.8rem; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Aktif Sinyal</div>
                    <div id="mainActiveSignals" style="font-size: 1rem; font-weight: 600; color: #888;">⏳ Sinyal Yok</div>
                </div>
            </div>
            
            <!-- Hızlı Eylemler -->
            <div style="margin-top: 25px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <button class="btn warning" onclick="toggleTheme()">
                    🌙 Tema Değiştir
                </button>
                <button class="btn info" onclick="showHelp()">
                    ❓ Yardım
                </button>
                <button class="btn" onclick="showStats()">
                    📊 İstatistikler
                </button>
            </div>
        </div>

        <!-- Ana Grid Başlangıcı -->
        <div class="grid">
            <!-- Bağlantı ve Kontrol Paneli -->
            <div class="panel">
                <h3>🔗 Bağlantı ve Kontrol Merkezi</h3>
                
                <!-- Coin Seçimi -->
                <div style="margin-bottom: 25px;">
                    <label style="font-size: 1rem; color: #ccc; margin-bottom: 12px; display: block; font-weight: 500;">
                        📈 Analiz Edilecek Coin:
                    </label>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="manualSymbol" placeholder="Coin sembolü (BTC, ETH, PEPE...)" 
                               style="flex: 1;" value="BTC">
                        <button class="btn info" onclick="connect()" style="padding: 14px 20px;">
                            🔍 Ara
                        </button>
                    </div>
                    
                    <!-- Bağlantı Butonu -->
                    <button class="btn success" id="connectBtn" onclick="toggleConnection()" 
                            style="width: 100%; font-size: 1.1rem; padding: 16px;">
                        🔌 WebSocket Bağlantısını Başlat
                    </button>
                </div>
                
                <!-- Detaylı Bağlantı Bilgileri -->
                <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);">
                    <h4 style="color: #4ECDC4; margin-bottom: 15px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                        📡 Bağlantı Detayları
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9rem;">
                        <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 4px;">WebSocket Durumu:</div>
                            <div id="wsStatus" style="color: #F84960; font-weight: 600;">🔴 Kapalı</div>
                        </div>
                        <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 4px;">Aktif Sembol:</div>
                            <div id="currentSymbol" style="color: #4ECDC4; font-weight: 600;">-</div>
                        </div>
                        <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 4px;">Son Güncelleme:</div>
                            <div id="lastUpdate" style="color: #888; font-weight: 600;">-</div>
                        </div>
                        <div style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 4px;">Çalışma Süresi:</div>
                            <div id="uptime" style="color: #888; font-weight: 600;">-</div>
                        </div>
                    </div>
                </div>

                <!-- Hızlı Eylemler -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn warning" onclick="toggleTheme()" style="flex: 1; min-width: 120px;">
                        🌙 Tema
                    </button>
                    <button class="btn info" onclick="showConnectionLog()" style="flex: 1; min-width: 120px;">
                        📋 Log
                    </button>
                    <button class="btn" onclick="resetConnection()" style="flex: 1; min-width: 120px;">
                        🔄 Reset
                    </button>
                </div>
            </div>

            <!-- Aktif Sinyal Detayları Paneli -->
            <div class="panel">
                <h3>🎯 Aktif Sinyal Detayları</h3>
                
                <div id="currentSignal" style="min-height: 140px; position: relative; overflow: hidden;">
                    <div id="noSignalState" style="text-align: center; color: #888; margin-top: 35px;">
                        <div style="font-size: 3rem; margin-bottom: 12px;">⏳</div>
                        <div style="font-size: 1.1rem; font-weight: 500; margin-bottom: 8px;">Sinyal bekleniyor...</div>
                        <div style="font-size: 0.85rem; color: #666;">AI market verilerini analiz ediyor</div>
                    </div>
                    
                    <div id="activeSignalState" style="display: none;">
                        <!-- Sinyal detayları buraya dinamik olarak eklenecek -->
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 0.9rem; color: #ccc; font-weight: 500;">Güven Seviyesi:</span>
                        <span id="confidencePercent" style="color: #4ECDC4; font-weight: 600; font-size: 1rem;">0%</span>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); border-radius: 10px; height: 12px; overflow: hidden; position: relative;">
                        <div id="confidenceBar" style="background: linear-gradient(90deg, #F84960 0%, #FFC107 50%, #00D4AA 100%); height: 100%; width: 0%; transition: width 0.8s ease; border-radius: 10px; position: relative;">
                            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite;"></div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; font-size: 0.7rem; margin-top: 6px; color: #888;">
                        <span>Düşük (0-50%)</span>
                        <span>Orta (50-75%)</span>
                        <span>Yüksek (75-100%)</span>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                        <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 4px;">Entry Price:</div>
                            <div id="signalEntryPrice" style="color: #4ECDC4; font-weight: 600;">-</div>
                        </div>
                        <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 4px;">Strateji:</div>
                            <div id="signalStrategy" style="color: #FFC107; font-weight: 600;">-</div>
                        </div>
                        <div style="padding: 10px; background: rgba(0,212,170,0.1); border-radius: 8px; border: 1px solid rgba(0,212,170,0.2);">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 4px;">Take Profit:</div>
                            <div id="signalTakeProfit" style="color: #00D4AA; font-weight: 600;">-</div>
                        </div>
                        <div style="padding: 10px; background: rgba(248,73,96,0.1); border-radius: 8px; border: 1px solid rgba(248,73,96,0.2);">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 4px;">Stop Loss:</div>
                            <div id="signalStopLoss" style="color: #F84960; font-weight: 600;">-</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn info" onclick="generateTestSignal()" style="width: 100%; margin-top: 10px;">
                    🧪 Test Sinyali Oluştur
                </button>
            </div>
            
            <!-- Debug Console Panel -->
            <div class="panel">
                <h3>🔧 Debug Console ve API Test</h3>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
                        <button class="btn info" onclick="clearDebugConsole()" style="padding: 8px 16px; font-size: 0.85rem;">
                            🗑️ Temizle
                        </button>
                        <button class="btn" onclick="toggleDebugAutoScroll()" id="autoScrollBtn" style="padding: 8px 16px; font-size: 0.85rem;">
                            📜 Auto Scroll: ON
                        </button>
                        <button class="btn warning" onclick="exportDebugLog()" style="padding: 8px 16px; font-size: 0.85rem;">
                            📤 Log Export
                        </button>
                    </div>
                </div>
                
                <div id="mobileDebugConsole" style="
                    background: rgba(0,0,0,0.9); 
                    border-radius: 10px; 
                    padding: 15px; 
                    max-height: 250px; 
                    overflow-y: auto; 
                    font-family: 'Courier New', 'Monaco', monospace; 
                    font-size: 11px;
                    border: 2px solid rgba(78, 205, 196, 0.3);
                    scrollbar-width: thin;
                    scrollbar-color: #4ECDC4 transparent;
                ">
                    <div style="color: #4ECDC4; border-left: 3px solid #4ECDC4; padding-left: 8px;">
                        [System Ready] 3C3 Signal Bot debug console hazır...
                    </div>
                    <div style="color: #888; border-left: 3px solid #888; padding-left: 8px; margin-top: 4px;">
                        [Info] WebSocket bağlantısı için coin sembolü girin
                    </div>
                </div>
            </div>

            <!-- Bot Ayarları Panel -->
            <div class="panel">
                <h3>⚙️ Bot Ayarları ve AI Konfigürasyonu</h3>
                
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #4ECDC4; font-size: 1rem; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        🎯 Sinyal Parametreleri
                    </h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.85rem; color: #ccc; margin-bottom: 8px; display: block;">
                            Volume Eşiği (1.2x - 5.0x):
                        </label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="range" id="volumeThreshold" min="1.2" max="5.0" step="0.1" value="2.0" 
                                   style="flex: 1; width: auto; margin: 0;" 
                                   onchange="updateBotSetting('volumeThreshold', this.value)"
                                   oninput="updateSliderDisplay('volumeThresholdValue', this.value + 'x')">
                            <span id="volumeThresholdValue" style="color: #00D4AA; font-weight: 600; min-width: 45px;">2.0x</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.85rem; color: #ccc; margin-bottom: 8px; display: block;">
                            Take Profit Yüzdesi (0.3% - 3.0%):
                        </label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="range" id="takeProfitPercent" min="0.3" max="3.0" step="0.1" value="0.8" 
                                   style="flex: 1; width: auto; margin: 0;" 
                                   onchange="updateBotSetting('takeProfitPercent', this.value)"
                                   oninput="updateSliderDisplay('takeProfitValue', this.value + '%')">
                            <span id="takeProfitValue" style="color: #00D4AA; font-weight: 600; min-width: 45px;">0.8%</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.85rem; color: #ccc; margin-bottom: 8px; display: block;">
                            Stop Loss Yüzdesi (0.2% - 2.0%):
                        </label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="range" id="stopLossPercent" min="0.2" max="2.0" step="0.1" value="0.5" 
                                   style="flex: 1; width: auto; margin: 0;" 
                                   onchange="updateBotSetting('stopLossPercent', this.value)"
                                   oninput="updateSliderDisplay('stopLossValue', this.value + '%')">
                            <span id="stopLossValue" style="color: #F84960; font-weight: 600; min-width: 45px;">0.5%</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.85rem; color: #ccc; margin-bottom: 8px; display: block;">
                            Minimum Güven Seviyesi (50% - 95%):
                        </label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="range" id="minConfidence" min="50" max="95" step="5" value="70" 
                                   style="flex: 1; width: auto; margin: 0;" 
                                   onchange="updateBotSetting('minConfidence', this.value)"
                                   oninput="updateSliderDisplay('minConfidenceValue', this.value + '%')">
                            <span id="minConfidenceValue" style="color: #4ECDC4; font-weight: 600; min-width: 45px;">70%</span>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 25px;">
                    <h4 style="color: #FF6B6B; font-size: 1rem; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        🧠 AI Öğrenme Ayarları
                    </h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.85rem; color: #ccc; display: flex; align-items: center; gap: 10px; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="autoOptimization" checked style="width: auto; margin: 0;" onchange="updateBotSetting('autoOptimization', this.checked)">
                            <span>Otomatik Optimizasyon</span>
                        </label>
                        
                        <label style="font-size: 0.85rem; color: #ccc; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="adaptiveThresholds" checked style="width: auto; margin: 0;" onchange="updateBotSetting('adaptiveThresholds', this.checked)">
                            <span>Adaptif Eşikler</span>
                        </label>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.85rem; color: #ccc; margin-bottom: 8px; display: block;">
                            AI Öğrenme Hızı:
                        </label>
                        <select id="learningSpeed" style="width: 100%; margin: 0; padding: 10px;" onchange="updateBotSetting('learningSpeed', this.value)">
                            <option value="slow">🐌 Yavaş</option>
                            <option value="medium" selected>⚡ Orta</option>
                            <option value="fast">🚀 Hızlı</option>
                        </select>
                    </div>
                </div>
               
                <div style="margin-top: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <button class="btn success" onclick="saveSettings()" style="padding: 12px; font-size: 0.9rem;">
                            💾 Ayarları Kaydet
                        </button>
                        <button class="btn warning" onclick="resetSettings()" style="padding: 12px; font-size: 0.9rem;">
                            🔄 Varsayılana Dön
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                        <button class="btn danger" onclick="resetAI()" style="padding: 10px; font-size: 0.8rem;">
                            🧠 AI Sıfırla
                        </button>
                        <button class="btn info" onclick="exportSettings()" style="padding: 10px; font-size: 0.8rem;">
                            📤 Export
                        </button>
                        <button class="btn info" onclick="importSettings()" style="padding: 10px; font-size: 0.8rem;">
                            📥 Import
                        </button>
                    </div>
                </div>
            </div>


            <!-- Strateji Performans Analizi Paneli -->
            <div class="panel">
                <h3>📊 Strateji Performans Analizi</h3>
                
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 0.85rem; color: #888; margin-bottom: 12px;">
                        AI sisteminin her strateji için öğrendiği performans metrikleri:
                    </div>
                    
                    <div style="background: rgba(255,107,107,0.1); border-radius: 10px; padding: 15px; margin-bottom: 12px; border: 1px solid rgba(255,107,107,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: #FF6B6B; display: flex; align-items: center; gap: 8px;">
                                🐋 Whale Orders Stratejisi
                            </span>
                            <span id="whaleSuccess" style="color: #FF6B6B; font-weight: 700; font-size: 1.1rem;">0% (0/0)</span>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,193,7,0.1); border-radius: 10px; padding: 15px; margin-bottom: 12px; border: 1px solid rgba(255,193,7,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: #FFC107; display: flex; align-items: center; gap: 8px;">
                                ⚖️ Order Imbalance Stratejisi
                            </span>
                            <span id="imbalanceSuccess" style="color: #FFC107; font-weight: 700; font-size: 1.1rem;">0% (0/0)</span>
                        </div>
                    </div>
                    
                    <div style="background: rgba(78,205,196,0.1); border-radius: 10px; padding: 15px; margin-bottom: 12px; border: 1px solid rgba(78,205,196,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: #4ECDC4; display: flex; align-items: center; gap: 8px;">
                                📈 Volume Spike Stratejisi
                            </span>
                            <span id="volumeSuccess" style="color: #4ECDC4; font-weight: 700; font-size: 1.1rem;">0% (0/0)</span>
                        </div>
                    </div>

                    <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, rgba(0,212,170,0.1), rgba(78,205,196,0.1)); border-radius: 12px; border: 2px solid rgba(0,212,170,0.3);">
                        <div style="font-size: 0.9rem; font-weight: 600; color: #00D4AA; margin-bottom: 8px;">
                            🏆 AI Tarafından Önerilen En İyi Strateji
                        </div>
                        <div style="font-size: 1rem; font-weight: 700; color: #ffffff;" id="bestStrategy">
                            Veri toplanıyor...
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h4 style="color: #4ECDC4; font-size: 0.95rem; margin-bottom: 10px;">📈 Performans Karşılaştırması:</h4>
                    <div id="strategyComparisonChart" style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 20px; text-align: center; color: #888; border: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 1.5rem; margin-bottom: 10px;">📊</div>
                        <div>Yeterli veri toplandıktan sonra grafik burada görünecek</div>
                    </div>
                </div>
            </div>
           
            <!-- Sinyal Geçmişi ve İstatistikler Paneli -->
            <div class="panel">
                <h3>📈 Sinyal Geçmişi ve Performans İstatistikleri</h3>
                
                <div style="margin-bottom: 25px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                        <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 2px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 1.8rem; font-weight: 700; color: #ffffff;" id="totalSignals">0</div>
                            <div style="font-size: 0.75rem; color: #888; text-transform: uppercase;">Toplam Sinyal</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(0,212,170,0.1); border-radius: 12px; border: 2px solid rgba(0,212,170,0.3);">
                            <div style="font-size: 1.8rem; font-weight: 700; color: #00D4AA;" id="successfulSignals">0</div>
                            <div style="font-size: 0.75rem; color: #888; text-transform: uppercase;">Başarılı</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(78,205,196,0.1); border-radius: 12px; border: 2px solid rgba(78,205,196,0.3);">
                            <div style="font-size: 1.8rem; font-weight: 700; color: #4ECDC4;" id="successRate">0.0%</div>
                            <div style="font-size: 0.75rem; color: #888; text-transform: uppercase;">Başarı Oranı</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(255,193,7,0.1); border-radius: 12px; border: 2px solid rgba(255,193,7,0.3);">
                            <div style="font-size: 1.8rem; font-weight: 700; color: #FFC107;" id="avgProfit">+0.00%</div>
                            <div style="font-size: 0.75rem; color: #888; text-transform: uppercase;">Avg Kar</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #4ECDC4; font-size: 1rem; margin-bottom: 15px;">
                        📋 Detaylı Sinyal Kayıtları
                    </h4>
                    
                    <div id="signalHistory" style="
                        max-height: 320px; 
                        overflow-y: auto; 
                        background: rgba(0,0,0,0.4); 
                        border-radius: 12px; 
                        padding: 15px; 
                        border: 2px solid rgba(255,255,255,0.1);
                        scrollbar-width: thin;
                        scrollbar-color: #4ECDC4 rgba(255,255,255,0.1);
                    ">
                        <div id="noSignalsMessage" style="text-align: center; color: #888; margin: 40px 0;">
                            <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.6;">📊</div>
                            <div style="font-size: 1.1rem; font-weight: 500;">Henüz sinyal geçmişi bulunmuyor</div>
                        </div>
                        
                        <div id="signalListContainer">
                            <!-- Bu alan JavaScript tarafından doldurulacak. -->
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn danger" onclick="clearHistory()">
                            🗑️ Geçmişi Temizle
                        </button>
                        <button class="btn info" onclick="exportHistory()">
                            📤 CSV Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Öğrenme Sistemi ve Sistem Sağlığı Paneli -->
            <div class="panel">
                <h3>🤖 AI Öğrenme Sistemi ve Performans Monitörü</h3>
                
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #FF6B6B; font-size: 1rem; margin-bottom: 15px;">
                        🧠 Neural Network Öğrenme Durumu
                    </h4>
                    
                    <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, transparent 30%, rgba(78,205,196,0.05) 50%, transparent 70%); animation: aiThinking 3s linear infinite;"></div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; position: relative; z-index: 1;">
                            <div>
                                <div style="font-size: 0.8rem; color: #888; margin-bottom: 6px;">İşlenen Veri:</div>
                                <div style="font-size: 1.4rem; font-weight: 700; color: #4ECDC4;" id="aiProcessedData">0</div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; color: #888; margin-bottom: 6px;">Öğrenme Doğruluğu:</div>
                                <div style="font-size: 1.4rem; font-weight: 700; color: #00D4AA;" id="aiAccuracy">0%</div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; color: #888; margin-bottom: 6px;">Performans Skoru:</div>
                                <div style="font-size: 1.4rem; font-weight: 700; color: #FFC107;" id="aiPerformance">0/100</div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; color: #888; margin-bottom: 6px;">Öğrenme Durumu:</div>
                                <div style="font-size: 1.1rem; font-weight: 600; color: #4ECDC4;" id="aiLearningStatus">Başlangıç</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; position: relative; z-index: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 0.8rem; color: #888;">Eğitim İlerlemesi:</span>
                                <span style="font-size: 0.9rem; font-weight: 600; color: #4ECDC4;" id="aiProgressPercent">0%</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); height: 12px; border-radius: 6px; overflow: hidden; position: relative;">
                                <div id="overallAIProgress" style="background: linear-gradient(90deg, #FF6B6B 0%, #FFC107 30%, #4ECDC4 70%, #00D4AA 100%); height: 100%; width: 0%; transition: width 1s ease;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #00D4AA; font-size: 1rem; margin-bottom: 15px;">
                        💚 Sistem Performansı
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div style="padding: 12px; background: rgba(255,193,7,0.05); border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.75rem; color: #888; margin-bottom: 6px;">Network Ping</div>
                            <div style="font-size: 1.3rem; font-weight: 700; color: #FFC107;" id="networkPing">-</div>
                        </div>
                        <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.75rem; color: #888; margin-bottom: 6px;">Çalışma Süresi</div>
                            <div style="font-size: 1.3rem; font-weight: 700; color: #ffffff;" id="systemUptime">00:00:00</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Verileri ve Teknik Analiz Paneli -->
            <div class="panel">
                <h3>📊 Market Verileri ve Teknik Analiz</h3>
                
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #4ECDC4; font-size: 1rem; margin-bottom: 15px;">
                        💹 Anlık Piyasa Durumu
                    </h4>
                    
                    <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 20px; border: 2px solid rgba(78,205,196,0.2);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: #888; margin-bottom: 6px;">24h Volume</div>
                                <div style="font-size: 1.4rem; font-weight: 700; color: #FFC107;" id="volume24h">0</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: #888; margin-bottom: 6px;">Volatilite</div>
                                <div style="font-size: 1.4rem; font-weight: 700; color: #FF6B6B;" id="marketVolatility">Düşük</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: #888; margin-bottom: 6px;">Piyasa Duygusu</div>
                                <div style="font-size: 1.4rem; font-weight: 700; color: #00D4AA;" id="marketSentiment">Nötr</div>
                            </div>
                        </div>
                    </div>
                </div>
               
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #FF6B6B; font-size: 1rem; margin-bottom: 12px;">📈 Teknik İndikatörler:</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div style="padding: 12px; background: rgba(255,107,107,0.1); border-radius: 8px;">
                            <div style="font-size: 0.8rem; color: #888; margin-bottom: 6px;">RSI (14)</div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: #FF6B6B;" id="rsiValue">50</div>
                        </div>
                        <div style="padding: 12px; background: rgba(78,205,196,0.1); border-radius: 8px;">
                            <div style="font-size: 0.8rem; color: #888; margin-bottom: 6px;">MACD</div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: #4ECDC4;" id="macdValue">0.00</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <h4 style="color: #00D4AA; font-size: 0.95rem; margin-bottom: 10px;">📚 OrderBook Analizi:</h4>
                    <div style="background: rgba(0,212,170,0.05); border-radius: 10px; padding: 15px; border: 1px solid rgba(0,212,170,0.2);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <div style="flex: 1; text-align: center;">
                                <div style="font-size: 0.75rem; color: #888; margin-bottom: 4px;">Alış Baskısı</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #00D4AA;" id="buyPressure">0%</div>
                            </div>
                            <div style="flex: 1; text-align: center;">
                                <div style="font-size: 0.75rem; color: #888; margin-bottom: 4px;">Satış Baskısı</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #F84960;" id="sellPressure">0%</div>
                            </div>
                        </div>
                        <div style="background: rgba(248,73,96,0.3); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="orderbookBalance" style="background: #00D4AA; height: 100%; width: 50%; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Toast Bildirim Sistemi -->
        <div id="toast" class="toast"></div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" style="
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.8); 
            backdrop-filter: blur(5px);
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 10000;
        ">
            <div style="text-align: center; color: #ffffff;">
                <div style="width: 60px; height: 60px; border: 4px solid rgba(78,205,196,0.3); border-top: 4px solid #4ECDC4; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;" id="loadingMessage">İşlem yapılıyor...</div>
            </div>
        </div>
    </div>

    <!-- CSS Animasyonları -->
    <style>
        @keyframes aiThinking {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(300%); }
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: #ffffff;
            padding: 15px 20px;
            border-radius: 12px;
            border-left: 4px solid #4ECDC4;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 9999;
            max-width: 350px;
            font-size: 14px;
            font-weight: 500;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success { border-left-color: #00D4AA; }
        .toast.error { border-left-color: #F84960; }
        .toast.warning { border-left-color: #FFC107; }
        .toast.info { border-left-color: #4ECDC4; }

        html { scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
        ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #4ECDC4, #00D4AA); border-radius: 4px; }
        .light-theme ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .light-theme ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #2c3e50, #34495e); }
    </style>

    <!-- JavaScript Başlangıcı - Sonraki adımlarda burayı dolduracağız -->
    <script>
       // === GÜNCELLENMİŞ NİHAİ JAVASCRIPT KODU (TÜM DÜZELTMELERLE) ===

// --- BÖLÜM 1: GLOBAL DEĞİŞKENLER ---
let ws = null;
let isConnected = false;
let currentSymbol = '';
let lastPrice = 0;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
let pingInterval = null;
let debugAutoScroll = true;
let systemStartTime = 0;
let priceHistory = [];
let volumeHistory = [];
let orderBookData = { bids: [], asks: [] };
let signalHistory = [];

// Sinyal üretildikten sonraki genel bekleme süresini tutan değişken
let lastSignalTimestamp = 0; 

// Varsayılan ayarlar
const defaultBotSettings = {
    volumeThreshold: 2.0,
    takeProfitPercent: 0.8,
    stopLossPercent: 0.5,
    minConfidence: 70,
    signalCooldown: 30000, // 30 saniye cooldown
    learningSpeed: 'medium',
    autoOptimization: true,
    adaptiveThresholds: true,
};
let botSettings = { ...defaultBotSettings };

let aiLearningData = {
    totalProcessed: 0,
    learningProgress: 0,
    performanceScore: 0,
    accuracy: 0,
    strategies: {
        'Volume Spike': { total: 0, success: 0, element: 'volumeSuccess' },
        'Order Imbalance': { total: 0, success: 0, element: 'imbalanceSuccess' },
        // HTML'deki "Whale Orders Stratejisi" ile uyumlu hale getirildi.
        'Whale Orders': { total: 0, success: 0, element: 'whaleSuccess' } 
    },
};


// --- BÖLÜM 2: TEMEL YARDIMCI FONKSİYONLAR ---
function safeUpdateElement(elementId, value, property = 'textContent') {
    const element = document.getElementById(elementId);
    if (element) element[property] = value;
}

function formatPrice(price) {
    if (!price || price === 0) return '$0.00000000';
    if (price >= 1) return `$${price.toFixed(4)}`;
    if (price >= 0.01) return `$${price.toFixed(6)}`;
    return `$${price.toFixed(8)}`;
}

function formatUptime(totalSeconds) {
    const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
    const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
    const seconds = String(totalSeconds % 60).padStart(2, '0');
    return `${hours}:${minutes}:${seconds}`;
}

function showToast(message, type = 'info', duration = 3000) {
    const toast = document.getElementById('toast');
    if (!toast) return;
    toast.textContent = message;
    toast.className = `toast show ${type}`;
    setTimeout(() => { toast.classList.remove('show'); }, duration);
}

function addToMobileDebug(message, type = 'info') {
    const consoleEl = document.getElementById('mobileDebugConsole');
    if (!consoleEl) return;
    const colors = { info: '#4ECDC4', success: '#00D4AA', warning: '#FFC107', error: '#F84960', ai: '#FF6B6B' };
    const timestamp = new Date().toLocaleTimeString('tr-TR');
    const logEntry = document.createElement('div');
    logEntry.style.color = colors[type] || colors.info;
    logEntry.style.borderLeft = `3px solid ${colors[type] || colors.info}`;
    logEntry.style.paddingLeft = '8px';
    logEntry.style.marginBottom = '4px';
    logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${message}`;
    consoleEl.prepend(logEntry);
    if (debugAutoScroll) consoleEl.scrollTop = 0;
    if (consoleEl.children.length > 200) consoleEl.removeChild(consoleEl.lastChild);
}

function validateSymbol(symbol) {
    const coin = symbol.trim().toUpperCase();
    if (/^[A-Z0-9]{2,10}$/.test(coin)) {
        return { valid: true, coin: coin + '_USDT', message: `🔍 ${coin}_USDT analizi başlatılıyor...` };
    }
    return { valid: false, coin: null, message: `❌ Geçersiz format. Örnek: BTC, ETH, PEPE` };
}

// --- BÖLÜM 3: WEBSOCKET BAĞLANTI YÖNETİMİ ---
function connect() {
    if (isConnected) { showToast('ℹ️ Zaten bir bağlantı aktif.', 'info'); return; }
    const validation = validateSymbol(document.getElementById('manualSymbol').value);
    if (!validation.valid) { showToast(validation.message, 'error'); return; }
    currentSymbol = validation.coin;
    addToMobileDebug(`🔗 ${currentSymbol} için MEXC bağlantısı kuruluyor...`, 'info');
    updateConnectionUI('connecting');
    ws = new WebSocket('wss://futures.mexc.com/edge');
    ws.onopen = () => {
        isConnected = true;
        reconnectAttempts = 0;
        systemStartTime = Date.now();
        updateConnectionUI('connected');
        addToMobileDebug(`✅ MEXC WebSocket bağlantısı kuruldu.`, 'success');
        showToast(`✅ ${currentSymbol} için bağlantı başarılı!`, 'success');
        subscribeToPair(currentSymbol);
        startPingSystem();
    };
    ws.onmessage = (event) => {
        try { handleMarketData(JSON.parse(event.data)); } catch (error) { addToMobileDebug(`❌ Veri işleme hatası: ${error.message}`, 'error'); }
    };
    ws.onclose = (event) => {
        isConnected = false;
        updateConnectionUI('disconnected');
        addToMobileDebug(`⚠️ WebSocket bağlantısı kapandı (Kod: ${event.code})`, 'warning');
        stopPingSystem();
        if (event.code !== 1000) attemptReconnection();
    };
    ws.onerror = (error) => {
        addToMobileDebug(`❌ WebSocket bağlantı hatası!`, 'error');
        showToast('❌ Bağlantı hatası oluştu.', 'error');
        updateConnectionUI('disconnected');
    };
}

function disconnect() {
    if (ws) ws.close(1000, 'Kullanıcı tarafından kapatıldı');
    resetSystemState();
}

function resetConnection() {
    if (ws) disconnect();
    setTimeout(connect, 500); // Küçük bir gecikme ile tekrar bağlan
}

function toggleConnection() { isConnected ? disconnect() : connect(); }

function resetSystemState() {
    isConnected = false;
    lastPrice = 0;
    currentSymbol = '';
    priceHistory = [];
    volumeHistory = [];
    signalHistory = []; // Bağlantı kesildiğinde sinyal geçmişini de temizle
    lastSignalTimestamp = 0; // Sinyal cooldown'ını sıfırla

    updateConnectionUI('disconnected');
    updatePriceDisplay(0, 0);
    safeUpdateElement('stickySymbol', 'Coin seçin');
    safeUpdateElement('mainHeaderSymbol', 'Sembol Yok');
    updateSignalHistoryDisplay(); // Geçmişi temizle
    updateStatsPanels(); // İstatistikleri sıfırla
    updateAIStats(); // AI istatistiklerini sıfırla
    addToMobileDebug('🔴 WebSocket bağlantısı kapatıldı.', 'info');
}

function subscribeToPair(symbol) {
    if (!ws || ws.readyState !== WebSocket.OPEN) return;
    const subscriptions = [
        { method: 'sub.deal', param: { symbol } }, 
        { method: 'sub.depth', param: { symbol, depth: 20 } }, 
        { method: 'sub.ticker', param: { symbol } }
    ];
    subscriptions.forEach(sub => ws.send(JSON.stringify(sub)));
    addToMobileDebug(`📡 ${symbol} kanallarına abone olundu.`, 'info');
}

function startPingSystem() {
    stopPingSystem();
    pingInterval = setInterval(() => {
        if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ method: 'ping', param: { pong: Date.now() } }));
    }, 30000);
}

function stopPingSystem() { if (pingInterval) clearInterval(pingInterval); pingInterval = null; }

function attemptReconnection() {
    if (reconnectAttempts >= maxReconnectAttempts) { addToMobileDebug(`❌ Yeniden bağlanma limiti aşıldı.`, 'error'); return; }
    reconnectAttempts++;
    const delay = Math.min(5 * reconnectAttempts, 30) * 1000;
    addToMobileDebug(`🔄 ${delay / 1000}s sonra yeniden bağlanılacak... (${reconnectAttempts}/${maxReconnectAttempts})`, 'warning');
    setTimeout(() => { if (!isConnected) connect(); }, delay);
}

function updateConnectionUI(status) {
    const connectBtn = document.getElementById('connectBtn');
    const els = { ws: document.getElementById('wsStatus'), sticky: document.getElementById('stickyConnection'), main: document.getElementById('mainConnectionStatus') };
    if (status === 'connecting') {
        connectBtn.textContent = '⏳ Bağlanılıyor...'; connectBtn.disabled = true;
        Object.values(els).forEach(el => { if (el) { el.textContent = '⏳ Bağlanılıyor...'; el.style.color = '#FFC107'; } });
    } else if (status === 'connected') {
        connectBtn.textContent = '🔌 Bağlantıyı Kes'; connectBtn.className = 'btn danger'; connectBtn.disabled = false;
        Object.values(els).forEach(el => { if (el) { el.textContent = '✅ Bağlı'; el.style.color = '#00D4AA'; } });
        els.sticky.innerHTML = '✅ Bağlı'; els.sticky.className = 'quick-status status-connected';
    } else {
        connectBtn.textContent = '🔌 WebSocket Bağlantısını Başlat'; connectBtn.className = 'btn success'; connectBtn.disabled = false;
        els.ws.textContent = '🔴 Kapalı'; els.ws.style.color = '#F84960';
        els.sticky.innerHTML = '🔴 Bağlantısız'; els.sticky.className = 'quick-status status-disconnected';
        els.main.textContent = '🔴 Bağlantı Yok'; els.main.style.color = '#F84960';
    }
}

// --- BÖLÜM 4: VERİ İŞLEME VE ANALİZ ---
function handleMarketData(data) {
    if (data.method === 'pong') { try { safeUpdateElement('networkPing', `${Date.now() - JSON.parse(data.param).pong}ms`); } catch (e) {} return; }
    if (!data.channel || !data.data) return;
    switch (data.channel) {
        case 'push.deal': handleTradeData(data.data); break;
        case 'push.ticker': handleTickerData(data.data); break;
        case 'push.depth': handleOrderBookData(data.data); break;
    }
    aiLearningData.totalProcessed++;
    updateAllAnalytics();
}

function handleTradeData(tradeData) {
    const price = parseFloat(tradeData.p);
    if (isNaN(price) || price <= 0) return;
    checkSignalOutcome(price);
    const changePercent = lastPrice > 0 ? ((price - lastPrice) / lastPrice) * 100 : 0;
    updatePriceDisplay(price, changePercent);
    lastPrice = price;
    priceHistory.push(price);
    if (priceHistory.length > 200) priceHistory.shift();
}

function handleTickerData(tickerData) {
    const volume = parseFloat(tickerData.q);
    if (!isNaN(volume)) {
        safeUpdateElement('volume24h', (volume / 1000000).toFixed(2) + 'M USDT');
        volumeHistory.push(volume);
        if (volumeHistory.length > 100) volumeHistory.shift();
    }
}

function handleOrderBookData(depthData) {
    if (depthData.bids && depthData.asks) {
        orderBookData.bids = depthData.bids.map(bid => [parseFloat(bid[0]), parseFloat(bid[1])]);
        orderBookData.asks = depthData.asks.map(ask => [parseFloat(ask[0]), parseFloat(ask[1])]);
    }
}

function updatePriceDisplay(price, change) {
    const formattedPrice = formatPrice(price);
    safeUpdateElement('stickyPrice', formattedPrice);
    safeUpdateElement('mainHeaderPrice', formattedPrice);
    const symbolText = currentSymbol.replace('_USDT', '');
    safeUpdateElement('stickySymbol', symbolText);
    safeUpdateElement('mainHeaderSymbol', symbolText);
    safeUpdateElement('lastUpdateTime', `Son güncelleme: ${new Date().toLocaleTimeString('tr-TR')}`);
    const changeEl = document.getElementById('stickyChange'), mainChangeEl = document.getElementById('mainHeaderChange');
    if (price === 0) {
        changeEl.className = 'price-change positive'; mainChangeEl.style.color = '#00D4AA';
        changeEl.innerHTML = `<span>📈</span><span>+0.000%</span>`; mainChangeEl.textContent = `+0.000%`; return;
    }
    if (change >= 0) {
        changeEl.className = 'price-change positive'; mainChangeEl.style.color = '#00D4AA';
        changeEl.innerHTML = `<span>📈</span><span>+${change.toFixed(3)}%</span>`;
    } else {
        changeEl.className = 'price-change negative'; mainChangeEl.style.color = '#F84960';
        changeEl.innerHTML = `<span>📉</span><span>${change.toFixed(3)}%</span>`;
    }
    mainChangeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(3)}%`;
}

// --- BÖLÜM 5: TEKNİK ANALİZ ---
function updateAllAnalytics() {
    if (priceHistory.length < 26) return;
    const rsi = calculateRSI(14);
    safeUpdateElement('rsiValue', rsi.toFixed(2));
    const macd = calculateMACD(12, 26, 9);
    safeUpdateElement('macdValue', macd.macd.toFixed(5));
    const volatility = calculateVolatility(20);
    safeUpdateElement('marketVolatility', volatility.toFixed(2) + '%');
    const imbalance = analyzeOrderBookImbalance();
    const sentiment = calculateMarketSentiment(rsi);
    safeUpdateElement('marketSentiment', sentiment.text);
    checkForSignal(rsi, macd, imbalance, volatility);
    updateAIStats();
}
function calculateRSI(period) { if (priceHistory.length <= period) return 50; let gains = 0, losses = 0; for (let i = 1; i <= period; i++) { const diff = priceHistory[i] - priceHistory[i-1]; if (diff >= 0) gains += diff; else losses -= diff; } let avgGain = gains / period, avgLoss = losses / period; for (let i = period + 1; i < priceHistory.length; i++) { const diff = priceHistory[i] - priceHistory[i-1]; if (diff >= 0) { avgGain = (avgGain * (period - 1) + diff) / period; avgLoss = (avgLoss * (period - 1)) / period; } else { avgLoss = (avgLoss * (period - 1) - diff) / period; avgGain = (avgGain * (period - 1)) / period; } } if (avgLoss === 0) return 100; const rs = avgGain / avgLoss; return 100 - (100 / (1 + rs)); }
function calculateEMA(data, period) { const k = 2 / (period + 1); let emaArray = [data[0]]; for (let i = 1; i < data.length; i++) emaArray.push(data[i] * k + emaArray[i - 1] * (1 - k)); return emaArray; }
function calculateMACD(short, long, signal) { if (priceHistory.length < long) return { macd: 0, signal: 0 }; const emaShort = calculateEMA(priceHistory, short); const emaLong = calculateEMA(priceHistory, long); const macdLine = emaShort.map((val, i) => val - emaLong[i]); const signalLine = calculateEMA(macdLine, signal); return { macd: macdLine[macdLine.length - 1], signal: signalLine[signalLine.length - 1] }; }
function calculateVolatility(period) { if (priceHistory.length < period) return 0; const prices = priceHistory.slice(-period); const mean = prices.reduce((a, b) => a + b, 0) / period; const variance = prices.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / period; const stdDev = Math.sqrt(variance); return (stdDev / mean) * 100; }
function analyzeOrderBookImbalance() { if (!orderBookData.bids || orderBookData.bids.length === 0) return { buyPressure: 50, sellPressure: 50 }; const bidVolume = orderBookData.bids.slice(0, 10).reduce((sum, bid) => sum + (bid[0] * bid[1]), 0); const askVolume = orderBookData.asks.slice(0, 10).reduce((sum, ask) => sum + (ask[0] * ask[1]), 0); const totalVolume = bidVolume + askVolume; if (totalVolume === 0) return { buyPressure: 50, sellPressure: 50 }; const buyPressure = (bidVolume / totalVolume) * 100; safeUpdateElement('buyPressure', `${buyPressure.toFixed(1)}%`); safeUpdateElement('sellPressure', `${(100 - buyPressure).toFixed(1)}%`); const balanceBar = document.getElementById('orderbookBalance'); if (balanceBar) balanceBar.style.width = `${buyPressure}%`; return { buyPressure: buyPressure, sellPressure: 100 - buyPressure }; }
function calculateMarketSentiment(rsi) { if (rsi > 70) return { text: "Aşırı Alım" }; if (rsi < 30) return { text: "Aşırı Satım" }; if (rsi > 60) return { text: "Pozitif" }; if (rsi < 40) return { text: "Negatif" }; return { text: "Nötr" }; }

// --- BÖLÜM 6: SİNYAL ÜRETİMİ ---
function checkForSignal(rsi, macd, imbalance, volatility) {
    const now = Date.now();
    // Genel cooldown kontrolü: Eğer son sinyal üretim zamanından bu yana yeterli süre geçmediyse çık.
    if ((now - lastSignalTimestamp) < botSettings.signalCooldown) {
        // addToMobileDebug('⏳ Sinyal cooldown aktif, yeni sinyal engellendi.', 'warning');
        return;
    }

    // Piyasa hareketine göre Whale Orders sinyali simülasyonu (RSI Extreme olarak kullanıldı)
    if (rsi > 75 || rsi < 25) { // Aşırı alım veya aşırı satım
        const side = rsi > 75 ? 'SHORT' : 'LONG'; // Aşırı alımda SHORT, aşırı satımda LONG
        const confidence = 70 + Math.abs(rsi - 50) * 0.5; // RSI'den ne kadar uzaksa o kadar güvenli
        generateSignal('Whale Orders', side, confidence, `RSI aşırı seviyede (${rsi.toFixed(0)}).`);
        return;
    }

    if (volumeHistory.length > 10) {
        const currentVolume = volumeHistory[volumeHistory.length-1], avgVolume = volumeHistory.slice(-11,-1).reduce((s,v)=>s+v,0)/10;
        if (avgVolume > 0 && (currentVolume / avgVolume) > botSettings.volumeThreshold) {
            const side = (lastPrice-priceHistory[priceHistory.length-2]) > 0 ? 'LONG':'SHORT';
            const confidence = Math.min(95, 65+((currentVolume/avgVolume)-botSettings.volumeThreshold)*5);
            generateSignal('Volume Spike', side, confidence, `Hacim patlaması (${(currentVolume/avgVolume).toFixed(1)}x)`); return;
        }
    }
    if (imbalance.buyPressure > 65) { generateSignal('Order Imbalance','LONG',60+(imbalance.buyPressure-65),`Alış baskısı (%${imbalance.buyPressure.toFixed(0)})`); return; }
    if (imbalance.sellPressure > 65) { generateSignal('Order Imbalance','SHORT',60+(imbalance.sellPressure-65),`Satış baskısı (%${imbalance.sellPressure.toFixed(0)})`); return; }
}

function generateSignal(strategy, side, confidence, reason) {
    if (confidence < botSettings.minConfidence) return;
    
    // Sinyal üretildi, genel cooldown zamanını güncelle
    lastSignalTimestamp = Date.now(); 

    const signal = { id:`SIG_${Date.now()}`, strategy, side, symbol:currentSymbol.replace('_USDT',''), entryPrice:lastPrice, takeProfit:calculateTakeProfit(lastPrice,side), stopLoss:calculateStopLoss(lastPrice,side), confidence:Math.round(confidence), reason, timestamp:Date.now(), status:'PENDING', outcome:'N/A' };
    addToMobileDebug(`🎯 YENİ SİNYAL: ${side} ${signal.symbol} | Strateji: ${strategy} | Güven: ${signal.confidence}%`, 'ai');
    showToast(`Yeni Sinyal: ${side} ${signal.symbol}!`, 'success');
    signalHistory.unshift(signal);
    updateActiveSignalDisplay(signal);
    updateSignalHistoryDisplay();
    updateStatsPanels();

    safeUpdateElement('mainAiStatus','🎯 Sinyal Üretildi!','innerHTML'); document.getElementById('mainAiStatus').style.color='#00D4AA';
    safeUpdateElement('mainActiveSignals',`${side} ${signal.confidence}%`,'innerHTML'); document.getElementById('mainActiveSignals').style.color = side==='LONG'?'#00D4AA':'#F84960';
    setTimeout(() => { safeUpdateElement('mainAiStatus','🧠 AI Analiz Ediyor','innerHTML'); document.getElementById('mainAiStatus').style.color='#4ECDC4'; },15000);
}
function calculateTakeProfit(price,side) { const f=botSettings.takeProfitPercent/100; return side==='LONG'?price*(1+f):price*(1-f); }
function calculateStopLoss(price,side) { const f=botSettings.stopLossPercent/100; return side==='LONG'?price*(1-f):price*(1+f); }

// --- BÖLÜM 7: İSTATİSTİKLER ---
function checkSignalOutcome(price) {
    const pSignal = signalHistory.find(s => s.status === 'PENDING');
    if (!pSignal) return;
    let outcome = null, pnl = 0;
    
    // Cooldown aktifken sinyal sonuçlandırma mantığını atla
    // Bu kısım sadece aktif bir sinyal varsa ve cooldown süresi geçmişse çalışmalı
    // VEYA, her zaman aktif sinyal TP/SL kontrolünü yapmalı ama yeni sinyal üretimine cooldown uygulamalı
    // Şimdilik, sadece pending sinyalin sonucunu kontrol etmeye devam edelim.

    if (pSignal.side==='LONG' && price>=pSignal.takeProfit) { outcome='SUCCESS'; pnl=(pSignal.takeProfit-pSignal.entryPrice)/pSignal.entryPrice; }
    else if(pSignal.side==='LONG' && price<=pSignal.stopLoss) { outcome='FAIL'; pnl=(pSignal.stopLoss-pSignal.entryPrice)/pSignal.entryPrice; }
    else if(pSignal.side==='SHORT' && price<=pSignal.takeProfit) { outcome='SUCCESS'; pnl=(pSignal.entryPrice-pSignal.takeProfit)/pSignal.entryPrice; }
    else if(pSignal.side==='SHORT' && price>=pSignal.stopLoss) { outcome='FAIL'; pnl=(pSignal.entryPrice-pSignal.stopLoss)/pSignal.entryPrice; }
    
    if(outcome){
        pSignal.status='CLOSED'; pSignal.outcome=outcome; pSignal.pnl=pnl*100;
        // İlgili stratejinin başarı verilerini güncelle
        if (aiLearningData.strategies[pSignal.strategy]) {
            aiLearningData.strategies[pSignal.strategy].total++;
            if (outcome === 'SUCCESS') {
                aiLearningData.strategies[pSignal.strategy].success++;
            }
        }
        showToast(`Sinyal Sonuçlandı: ${outcome}`,outcome==='SUCCESS'?'success':'error');
        addToMobileDebug(`📊 Sinyal ${pSignal.id} sonuçlandı: ${outcome}, PNL: ${pSignal.pnl.toFixed(2)}%`,'info');
        updateActiveSignalDisplay(null); updateSignalHistoryDisplay(); updateStatsPanels(); updateAIStats();
    }
}

function updateStatsPanels() {
    const closedSignals = signalHistory.filter(s => s.status === 'CLOSED');
    
    // Toplam sinyal ve başarı oranı
    safeUpdateElement('totalSignals', closedSignals.length);
    const successfulSignals = closedSignals.filter(s => s.outcome === 'SUCCESS');
    safeUpdateElement('successfulSignals', successfulSignals.length);
    const successRate = closedSignals.length > 0 ? (successfulSignals.length / closedSignals.length) * 100 : 0;
    safeUpdateElement('successRate', `${successRate.toFixed(1)}%`);
    
    // Ortalama kar
    const totalProfit = closedSignals.reduce((s,c)=>s+(c.pnl||0),0);
    const avgProfit = closedSignals.length > 0 ? totalProfit / closedSignals.length : 0;
    safeUpdateElement('avgProfit', `${avgProfit.toFixed(2)}%`);

    // Strateji Performansı
    for (const key in aiLearningData.strategies) {
        const strat = aiLearningData.strategies[key];
        const stratSignals = closedSignals.filter(s => s.strategy === key);
        if (stratSignals.length > 0) {
            const successful = stratSignals.filter(s => s.outcome === 'SUCCESS').length;
            const rate = (successful/stratSignals.length)*100;
            safeUpdateElement(strat.element, `${rate.toFixed(0)}% (${successful}/${stratSignals.length})`);
        } else {
            safeUpdateElement(strat.element, `0% (0/0)`); // Veri yoksa sıfır göster
        }
    }

    // En iyi strateji önerisi
    let bestStrategyName = 'Veri toplanıyor...';
    let bestStrategyDetails = 'En az 3 işlem tamamlandıktan sonra AI en iyi stratejiyi belirleyecek';
    let maxSuccessRate = -1;
    let totalStratSignalsCount = 0; // Stratejilerin toplam sinyal sayısı

    for (const key in aiLearningData.strategies) {
        totalStratSignalsCount += aiLearningData.strategies[key].total;
    }

    if (totalStratSignalsCount >= 3) { // En az 3 sinyal geçmişi varsa
        for (const key in aiLearningData.strategies) {
            const strat = aiLearningData.strategies[key];
            if (strat.total > 0) {
                const currentRate = (strat.success / strat.total) * 100;
                if (currentRate > maxSuccessRate) {
                    maxSuccessRate = currentRate;
                    bestStrategyName = key;
                    bestStrategyDetails = `Başarı Oranı: ${currentRate.toFixed(1)}% (${strat.success}/${strat.total}) - Ortalama PnL: ${closedSignals.filter(s => s.strategy === key).reduce((s,c)=>s+(c.pnl||0),0) / stratSignals.length || 0}%`;
                }
            }
        }
        if (bestStrategyName === 'Veri toplanıyor...') { // Hiçbir strateji işlem tamamlamadıysa
             bestStrategyDetails = 'Henüz tamamlanmış sinyal yok';
        }
    }

    safeUpdateElement('bestStrategy', bestStrategyName);
    safeUpdateElement('bestStrategyDetails', bestStrategyDetails);
}

function updateAIStats() {
    // AI öğrenme verilerini AI Öğrenme Sistemi panelinde göster
    safeUpdateElement('aiProcessedData', aiLearningData.totalProcessed.toLocaleString());
    
    // Öğrenme ilerlemesi (işlenen veri sayısına bağlı)
    aiLearningData.learningProgress = Math.min(95, Math.log10(aiLearningData.totalProcessed + 1) * 20); // Daha dinamik bir ilerleme
    safeUpdateElement('aiProgressPercent', `${Math.floor(aiLearningData.learningProgress)}%`);
    const progressBar = document.getElementById('overallAIProgress');
    if (progressBar) progressBar.style.width = `${aiLearningData.learningProgress}%`;

    // AI doğruluğu (gerçekleşen sinyallerin başarı oranına bağlı)
    const closedSignals = signalHistory.filter(s => s.status === 'CLOSED');
    aiLearningData.accuracy = closedSignals.length > 0 ? (closedSignals.filter(s => s.outcome === 'SUCCESS').length / closedSignals.length) * 100 : 0;
    safeUpdateElement('aiAccuracy', `${aiLearningData.accuracy.toFixed(1)}%`);

    // Genel performans skoru
    aiLearningData.performanceScore = (aiLearningData.accuracy * 0.7) + (aiLearningData.learningProgress * 0.3); // Doğruluk daha ağırlıklı
    safeUpdateElement('aiPerformance', `${Math.floor(aiLearningData.performanceScore)}/100`);

    // AI durum metni
    let aiStatusText = 'Başlangıç Modu';
    if (aiLearningData.learningProgress > 80 && aiLearningData.accuracy > 70) {
        aiStatusText = 'Uzman Seviye (Yüksek Performans)';
    } else if (aiLearningData.learningProgress > 50 && aiLearningData.accuracy > 50) {
        aiStatusText = 'Gelişmiş Seviye (Aktif Öğrenme)';
    } else if (aiLearningData.learningProgress > 10) {
        aiStatusText = 'Öğrenme Modu (Veri Analizi)';
    }
    safeUpdateElement('aiLearningStatus', aiStatusText);
}


// --- BÖLÜM 8: ARAYÜZ GÜNCELLEME (SİNYAL & GEÇMİŞ) ---
function updateActiveSignalDisplay(signal) { 
    const noSignalState = document.getElementById('noSignalState'); 
    const activeSignalState = document.getElementById('activeSignalState'); 
    if (!signal) { 
        noSignalState.style.display = 'block'; 
        activeSignalState.style.display = 'none'; 
        // Sinyal yokken güven barını ve metnini sıfırla
        safeUpdateElement('confidencePercent', '0%');
        const confidenceBar = document.getElementById('confidenceBar');
        if (confidenceBar) confidenceBar.style.width = '0%';
        safeUpdateElement('signalEntryPrice', '-');
        safeUpdateElement('signalStrategy', '-');
        safeUpdateElement('signalTakeProfit', '-');
        safeUpdateElement('signalStopLoss', '-');
        return; 
    } 
    noSignalState.style.display = 'none'; 
    activeSignalState.style.display = 'block'; 
    const sideColor = signal.side === 'LONG' ? '#00D4AA' : '#F84960'; 
    const sideIcon = signal.side === 'LONG' ? '📈' : '📉'; 
    activeSignalState.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div>
                <div style="font-size: 1.3rem; font-weight: 700; color: ${sideColor}; display: flex; align-items: center; gap: 8px;">
                    ${sideIcon} ${signal.side} ${signal.symbol}
                </div>
                <div style="font-size: 0.85rem; color: #888; margin-top: 4px;">${signal.reason}</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 1.1rem; font-weight: 700; color: #4ECDC4;">${signal.confidence}%</div>
                <div style="font-size: 0.75rem; color: #888;">Güven</div>
            </div>
        </div>`; 
    safeUpdateElement('confidencePercent', `${signal.confidence}%`); 
    const confidenceBar = document.getElementById('confidenceBar'); 
    if (confidenceBar) confidenceBar.style.width = `${signal.confidence}%`; 
    safeUpdateElement('signalEntryPrice', formatPrice(signal.entryPrice)); 
    safeUpdateElement('signalStrategy', signal.strategy); 
    safeUpdateElement('signalTakeProfit', formatPrice(signal.takeProfit)); 
    safeUpdateElement('signalStopLoss', formatPrice(signal.stopLoss)); 
}
function updateSignalHistoryDisplay() {
    const container = document.getElementById('signalListContainer'), noMsg = document.getElementById('noSignalsMessage');
    if (!container || !noMsg) return;
    if (signalHistory.length === 0) { noMsg.style.display = 'block'; container.innerHTML = ''; return; }
    noMsg.style.display = 'none';
    container.innerHTML = signalHistory.slice(0, 50).map(signal => {
        let statusColor = '#FFC107', statusText = 'BEKLİYOR';
        if (signal.status === 'CLOSED') {
            statusColor = signal.outcome === 'SUCCESS' ? '#00D4AA' : '#F84960';
            statusText = signal.outcome === 'SUCCESS' ? `BAŞARILI (${signal.pnl.toFixed(2)}%)` : `BAŞARISIZ (${signal.pnl.toFixed(2)}%)`;
        }
        const sideColor = signal.side === 'LONG' ? '#00D4AA' : '#F84960';
        return `<div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;margin-bottom:8px;border-left:3px solid ${sideColor};"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><div style="font-weight:600;color:${sideColor};">${signal.side} ${signal.symbol}</div><div style="font-size:0.8rem;color:${statusColor};font-weight:600;">${statusText}</div></div><div style="font-size:0.8rem;color:#888;margin-bottom:6px;">Strateji: ${signal.strategy}</div><div style="display:flex;justify-content:space-between;font-size:0.75rem;"><span style="color:#888;">Giriş: ${formatPrice(signal.entryPrice)}</span><span style="color:#4ECDC4;">Güven: ${signal.confidence}%</span><span style="color:#666;">${new Date(signal.timestamp).toLocaleTimeString('tr-TR')}</span></div></div>`;
    }).join('');
}
function generateTestSignal() {
    if (!isConnected) { showToast('❌ Test sinyali için önce bağlantı kurun!', 'error'); return; }
    // Test sinyali için strateji listesine "Whale Orders" da eklendi.
    const strats = ['Volume Spike', 'Order Imbalance', 'Whale Orders']; 
    const sides = ['LONG', 'SHORT'];
    generateSignal(strats[Math.floor(Math.random()*strats.length)], sides[Math.floor(Math.random()*sides.length)], Math.floor(Math.random()*30)+70, 'Bu bir test sinyalidir.');
}


// --- BÖLÜM 9: AYARLAR VE YÖNETİM FONKSİYONLARI ---
function updateBotSetting(setting, value) { 
    botSettings[setting] = parseFloat(value); // Slider değerleri sayı olarak kaydedilsin
    if (setting === 'autoOptimization' || setting === 'adaptiveThresholds' || setting === 'learningSpeed') {
        botSettings[setting] = value; // Checkbox ve select için string/boolean kalır
    }
}
function updateSliderDisplay(elementId, value) { safeUpdateElement(elementId, value); }
function saveSettings() {
    localStorage.setItem('3c3_signal_bot_settings', JSON.stringify(botSettings));
    showToast('💾 Ayarlar tarayıcı hafızasına kaydedildi.', 'success');
}
function loadSettings() {
    const saved = localStorage.getItem('3c3_signal_bot_settings');
    if (saved) {
        // Yeni eklenen ayarlar için varsayılan değerleri koruyarak merge et
        botSettings = { ...defaultBotSettings, ...JSON.parse(saved) };
        addToMobileDebug('⚙️ Kayıtlı ayarlar yüklendi.', 'info');
    }
    updateSettingsUI();
}
function resetSettings() {
    botSettings = { ...defaultBotSettings }; // Varsayılan ayarlara dön
    localStorage.removeItem('3c3_signal_bot_settings'); // Kayıtlı ayarları sil
    updateSettingsUI(); // Arayüzü güncelle
    showToast('🔄 Ayarlar varsayılana döndürüldü.', 'warning');
}
function updateSettingsUI() {
    // Sliderlar ve inputlar için
    document.getElementById('volumeThreshold').value = botSettings.volumeThreshold;
    document.getElementById('takeProfitPercent').value = botSettings.takeProfitPercent;
    document.getElementById('stopLossPercent').value = botSettings.stopLossPercent;
    document.getElementById('minConfidence').value = botSettings.minConfidence;

    updateSliderDisplay('volumeThresholdValue', botSettings.volumeThreshold + 'x');
    updateSliderDisplay('takeProfitValue', botSettings.takeProfitPercent + '%');
    updateSliderDisplay('stopLossValue', botSettings.stopLossPercent + '%');
    updateSliderDisplay('minConfidenceValue', botSettings.minConfidence + '%');
    
    // Checkboxlar ve select için
    const autoOptEl = document.getElementById('autoOptimization');
    const adaptiveEl = document.getElementById('adaptiveThresholds');
    const learningEl = document.getElementById('learningSpeed');
    
    if (autoOptEl) autoOptEl.checked = botSettings.autoOptimization;
    if (adaptiveEl) adaptiveEl.checked = botSettings.adaptiveThresholds;
    if (learningEl) learningEl.value = botSettings.learningSpeed;
}
function exportSettings() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(botSettings, null, 2));
    const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", `3c3_ayarlar_${Date.now()}.json`); dl.click();
    showToast('📤 Ayarlar başarıyla dışa aktarıldı.', 'info');
}
function importSettings() {
    const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
    input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = readerEvent => {
            try {
                const content = JSON.parse(readerEvent.target.result);
                // defaultBotSettings ile birleştirerek yeni/eski ayarların uyumluluğunu sağla
                botSettings = { ...defaultBotSettings, ...content }; 
                saveSettings(); updateSettingsUI();
                showToast('📥 Ayarlar başarıyla içe aktarıldı.', 'success');
            } catch (err) { showToast('❌ Geçersiz ayar dosyası!', 'error'); }
        };
        reader.readAsText(file);
    };
    input.click();
}
function clearDebugConsole() { document.getElementById('mobileDebugConsole').innerHTML = ''; addToMobileDebug('Debug konsolu temizlendi.'); }
function toggleDebugAutoScroll() { debugAutoScroll = !debugAutoScroll; safeUpdateElement('autoScrollBtn', `📜 Auto Scroll: ${debugAutoScroll ? 'ON':'OFF'}`); }
function exportDebugLog() {
    const logs = Array.from(document.getElementById('mobileDebugConsole').children).map(c=>c.textContent).reverse().join('\n');
    const blob = new Blob([logs], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'debug-log.txt'; a.click();
    URL.revokeObjectURL(url);
}
function clearHistory() {
    if (confirm('Tüm sinyal geçmişi ve istatistikler silinecek. Emin misiniz?')) {
        signalHistory = [];
        lastSignalTimestamp = 0; // Geçmiş temizlendiğinde cooldown'ı sıfırla
        updateSignalHistoryDisplay();
        updateStatsPanels();
        updateAIStats(); // AI istatistiklerini de sıfırla
        showToast('🗑️ Sinyal geçmişi temizlendi.', 'warning');
    }
}
function exportHistory() {
    if (signalHistory.length === 0) { showToast('ℹ️ Export edilecek veri yok.', 'info'); return; }
    let csvContent = "ID,Strateji,Yon,Sembol,GirisFiyati,TP,SL,Guven,Sonuc,PNL\n";
    signalHistory.forEach(s => {
        const row = [s.id,s.strategy,s.side,s.symbol,s.entryPrice,s.takeProfit,s.stopLoss,s.confidence,s.outcome,s.pnl||0].map(item => `"${item}"`).join(','); // Tırnak içine alma
        csvContent += row + "\r\n";
    });
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", `sinyal_gecmisi_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.display = 'none'; // Gizle
    document.body.appendChild(link); // Body'ye ekle
    link.click(); // Tıkla
    document.body.removeChild(link); // Sonra kaldır
    URL.revokeObjectURL(url);
    showToast('📤 Sinyal geçmişi başarıyla dışa aktarıldı.', 'info');
}
function resetAI() {
    if (confirm('AI öğrenme verileri ve strateji istatistikleri sıfırlanacak. Emin misiniz?')) {
        aiLearningData.totalProcessed = 0;
        aiLearningData.learningProgress = 0;
        aiLearningData.performanceScore = 0;
        aiLearningData.accuracy = 0;
        Object.keys(aiLearningData.strategies).forEach(key => {
            aiLearningData.strategies[key].total = 0;
            aiLearningData.strategies[key].success = 0;
        });
        updateAIStats();
        updateStatsPanels(); // Strateji panellerini sıfırla
        showToast('🧠 AI verileri sıfırlandı.', 'warning');
    }
}

// --- BÖLÜM 10: SİSTEM BAŞLATMA ---
function updateSystemUptime() {
    if (!isConnected) { safeUpdateElement('uptime', '00:00:00'); safeUpdateElement('systemUptime', '00:00:00'); return; }
    const uptimeSeconds = Math.floor((Date.now() - systemStartTime) / 1000);
    const formatted = formatUptime(uptimeSeconds);
    safeUpdateElement('uptime', formatted); safeUpdateElement('systemUptime', formatted);
}
function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
function toggleTheme() {
    document.body.classList.toggle('light-theme');
    localStorage.setItem('3c3_theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
    showToast(`Tema değiştirildi: ${document.body.classList.contains('light-theme') ? 'Aydınlık' : 'Karanlık'}`, 'info');
}
document.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('3c3_theme') === 'light') document.body.classList.add('light-theme');
    loadSettings(); // Kaydedilmiş ayarları yükle
    addToMobileDebug('🚀 3C3 Signal Bot arayüzü başlatılıyor...', 'info');
    setInterval(updateSystemUptime, 1000);
    document.getElementById('manualSymbol').addEventListener('keypress', (e) => { if(e.key==='Enter'){ e.preventDefault(); connect(); }});
    showToast('👋 Hoş geldiniz! Analiz için bir coin girin.', 'info');
    addToMobileDebug('✅ Arayüz yüklendi. Bağlantı bekleniyor.', 'success');
    
    // UI ilk açıldığında panelleri güncel tut
    updateSignalHistoryDisplay();
    updateStatsPanels();
    updateAIStats();
});
window.addEventListener('beforeunload', function() { if (ws) ws.close(); });
    </script>
</body>
</html>
